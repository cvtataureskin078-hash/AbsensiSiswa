<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Absensi Siswa - Final UI v13</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;800&display=swap');
        
        /* WARNA DESAIN UTAMA (TETAP NORMAL) */
        :root { 
            --bg-page: #f1f3f6; 
            --card-bg: #ffffff; 
            --text-main: #000000; 
            --input-bg: #ffffff;
            /* WARNA TOMBOL KHUSUS (EKSPOR & KOSONGKAN) */
            --btn-special-bg: #000000; 
            --btn-special-text: #ffffff;
            --green: #10ac84; 
            --red: #ff4757; 
        }
        
        [data-theme="dark"] { 
            --bg-page: #121212; 
            --card-bg: #1e1e1e; 
            --text-main: #ffffff; 
            --input-bg: #2d2d2d;
            /* INVERT HANYA UNTUK TOMBOL KHUSUS */
            --btn-special-bg: #ffffff; 
            --btn-special-text: #000000;
        }
        
        body { font-family: 'Poppins', sans-serif; background: var(--bg-page); display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; padding: 15px; box-sizing: border-box; transition: 0.3s; }
        
        .main-card { 
            background: var(--card-bg); width: 100%; max-width: 900px; 
            display: flex; border-radius: 20px; color: var(--text-main); 
            position: relative; box-shadow: 0 10px 30px rgba(0,0,0,0.1); overflow: hidden;
        }

        .theme-toggle { 
            position: absolute !important; top: 15px !important; right: 15px !important; width: auto !important;
            padding: 8px 15px !important; border-radius: 50px; cursor: pointer; border: none; font-size: 10px; font-weight: 800; z-index: 1000;
            background: #000; color: #fff;
        }
        [data-theme="dark"] .theme-toggle { background: #fff; color: #000; }

        .left-panel { flex: 1.1; padding: 35px; border-right: 1px solid rgba(0,0,0,0.05); }
        .right-panel { flex: 1; padding: 35px; background: rgba(0,0,0,0.01); display: flex; flex-direction: column; }
        
        @media (max-width: 800px) { .main-card { flex-direction: column; } .left-panel, .right-panel { border: none; padding: 25px; } }

        .header-title { margin: 0 0 5px 0; font-weight: 800; font-size: 20px; text-transform: uppercase; color: var(--text-main); }
        .date-display { font-size: 12px; opacity: 0.7; font-weight: 600; margin-bottom: 20px; text-transform: uppercase; color: var(--text-main); }

        #cam-box { width: 100%; height: 230px; background: #000; border-radius: 12px; overflow: hidden; margin-bottom: 20px; }
        video { width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); }
        
        label { font-size: 10px; font-weight: 800; display: block; margin-bottom: 6px; opacity: 0.9; color: var(--text-main); }
        input, select { 
            width: 100%; padding: 12px; border-radius: 10px; border: 1.5px solid rgba(128,128,128,0.2); 
            background: var(--input-bg); color: var(--text-main); box-sizing: border-box; font-family: inherit; 
            margin-bottom: 15px; font-size: 13px; outline: none; 
        }

        button { border: none; border-radius: 12px; cursor: pointer; font-weight: 800; padding: 14px; width: 100%; transition: 0.3s; font-size: 13px; text-transform: uppercase; }
        
        .btn-cam { background: #2f3542; color: white; margin-bottom: 20px; }
        
        /* TOMBOL SIMPAN (HITAM/PUTIH BIASA) */
        .btn-simpan { 
            background: var(--text-main); 
            color: var(--card-bg); 
            height: 55px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        /* 2 BLOK TOMBOL YANG DIMINTA (INVERT) */
        .btn-special {
            background: var(--btn-special-bg);
            color: var(--btn-special-text);
            height: 55px;
            margin-top: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        #list { flex-grow: 1; overflow-y: auto; max-height: 420px; margin-top: 15px; }
        .item { 
            background: var(--card-bg); padding: 15px; margin-bottom: 10px; border-radius: 15px; 
            display: flex; align-items: center; gap: 15px; border: 1px solid rgba(0,0,0,0.05); 
        }
        .foto-hasil { width: 70px; height: 70px; border-radius: 10px; object-fit: cover; border: 2px solid var(--text-main); }
        .info { flex-grow: 1; font-size: 11px; font-weight: 600; text-transform: uppercase; color: var(--text-main); }
        .info b { font-size: 14px; display: block; margin-bottom: 2px; }
        .badge { padding: 6px 12px; border-radius: 8px; color: #fff; font-size: 10px; font-weight: 800; min-width: 65px; text-align: center; }
    </style>
</head>
<body data-theme="light">

    <div class="main-card">
        <button class="theme-toggle" onclick="toggleTheme()" id="tBtn">ðŸŒ™ DARK MODE</button>

        <div class="left-panel">
            <h2 class="header-title">ABSENSI SISWA</h2>
            <div class="date-display" id="tglDisplay"></div>
            
            <div id="cam-box"><video id="video" autoplay muted playsinline></video></div>
            <canvas id="canvas" style="display:none;"></canvas>

            <button id="camBtn" class="btn-cam" onclick="toggleCam()">AKTIFKAN KAMERA</button>
            
            <label>NAMA LENGKAP SISWA</label>
            <input type="text" id="nama" placeholder="INPUT NAMA..." style="text-transform: uppercase;">
            
            <div style="display: flex; gap: 15px;">
                <div style="flex: 1;">
                    <label>NOMOR ABSENSI</label>
                    <input type="text" id="no" placeholder="00" oninput="this.value = this.value.replace(/[^0-9]/g, '');">
                </div>
                <div style="flex: 1;">
                    <label>STATUS</label>
                    <select id="stat">
                        <option value="" selected disabled>- PILIH -</option>
                        <option value="HADIR">HADIR</option>
                        <option value="IZIN">IZIN</option>
                        <option value="SAKIT">SAKIT</option>
                        <option value="ALFA">ALFA</option>
                    </select>
                </div>
            </div>
            
            <button class="btn-simpan" onclick="simpanData()">SIMPAN DATA ABSENSI</button>
        </div>

        <div class="right-panel">
            <h3 class="header-title" style="font-size: 17px;">DAFTAR HADIR</h3>
            <div id="list"></div>
            
            <button class="btn-special" onclick="eksporLaporan()">EKSPOR LAPORAN (PRINT)</button>
            <button class="btn-special" onclick="resetData()" style="background: var(--red); color: white; margin-top: 10px; height: 45px; font-size: 11px;">KOSONGKAN DATABASE</button>
        </div>
    </div>

<script>
    let dbAbsen = JSON.parse(localStorage.getItem('db_final_v13')) || [];
    let video = document.getElementById('video');
    let canvas = document.getElementById('canvas');
    let stream = null;

    const COLORS = { 'HADIR': '#10ac84', 'IZIN': '#f1c40f', 'SAKIT': '#e67e22', 'ALFA': '#ee5253' };

    function applyTheme(t) {
        document.body.setAttribute('data-theme', t);
        document.getElementById('tBtn').innerHTML = t === 'dark' ? 'â˜€ï¸ LIGHT MODE' : 'ðŸŒ™ DARK MODE';
        localStorage.setItem('theme_v13', t);
    }

    function toggleTheme() {
        let current = document.body.getAttribute('data-theme');
        applyTheme(current === 'light' ? 'dark' : 'light');
    }

    function getNow() {
        const d = new Date();
        const days = ["MINGGU", "SENIN", "SELASA", "RABU", "KAMIS", "JUMAT", "SABTU"];
        return days[d.getDay()] + ", " + String(d.getDate()).padStart(2, '0') + "/" + String(d.getMonth() + 1).padStart(2, '0') + "/" + d.getFullYear();
    }

    function setDateHeader() { document.getElementById('tglDisplay').innerText = getNow(); }

    function toggleCam() {
        let btn = document.getElementById('camBtn');
        if (!stream) {
            navigator.mediaDevices.getUserMedia({ video: true })
            .then(s => { stream = s; video.srcObject = s; btn.innerText = "MATIKAN KAMERA"; btn.style.background = "#ff4757"; })
            .catch(() => alert("Kamera error!"));
        } else {
            stream.getTracks().forEach(t => t.stop());
            video.srcObject = null; stream = null;
            btn.innerText = "AKTIFKAN KAMERA"; btn.style.background = "#2f3542";
        }
    }

    function simpanData() {
        let n = document.getElementById('nama').value;
        let nr = document.getElementById('no').value;
        let s = document.getElementById('stat').value;
        if(!n || !nr || !s) return alert("Lengkapi data!");

        let foto = "https://via.placeholder.com/150?text=NO+PHOTO";
        if (stream) {
            canvas.width = 320; canvas.height = 240;
            let ctx = canvas.getContext('2d');
            ctx.translate(canvas.width, 0); ctx.scale(-1, 1);
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            foto = canvas.toDataURL('image/jpeg', 0.8);
        }

        let time = new Date();
        let jam = time.getHours().toString().padStart(2, '0') + ":" + time.getMinutes().toString().padStart(2, '0');

        dbAbsen.push({ n: n.toUpperCase(), no: nr.padStart(2, '0'), s: s.toUpperCase(), jam: jam, tgl: getNow(), img: foto });
        localStorage.setItem('db_final_v13', JSON.stringify(dbAbsen));
        renderList();
        document.getElementById('nama').value = '';
        document.getElementById('no').value = '';
        document.getElementById('stat').selectedIndex = 0;
    }

    function renderList() {
        let listArea = document.getElementById('list');
        listArea.innerHTML = '';
        dbAbsen.slice().reverse().forEach(item => {
            listArea.innerHTML += `
                <div class="item">
                    <img src="${item.img}" class="foto-hasil">
                    <div class="info">
                        <b>${item.n}</b>
                        NO. ABSENSI : ${item.no} | ${item.jam}
                    </div>
                    <span class="badge" style="background:${COLORS[item.s]}">${item.s}</span>
                </div>`;
        });
    }

    function eksporLaporan() {
        if(dbAbsen.length === 0) return;
        let win = window.open('', '_blank');
        let html = `<html><head><style>
            * { text-transform: uppercase; font-family: sans-serif; }
            table { width: 100%; border-collapse: collapse; margin-top: 20px; }
            th { background: #000; color: white; padding: 12px; }
            td { padding: 10px; border: 1px solid #ddd; text-align: center; font-weight: bold; font-size: 12px; }
            img { width: 60px; height: 60px; border-radius: 8px; object-fit: cover; }
        </style></head><body onload="window.print()">
            <h2 style="text-align:center;">LAPORAN ABSENSI</h2>
            <table><tr><th>FOTO</th><th>NO</th><th>NAMA</th><th>WAKTU</th><th>STATUS</th></tr>`;
        dbAbsen.forEach(i => {
            html += `<tr><td><img src="${i.img}"></td><td>${i.no}</td><td style="text-align:left">${i.n}</td><td>${i.tgl}<br>${i.jam}</td><td>${i.s}</td></tr>`;
        });
        html += `</table></body></html>`;
        win.document.write(html);
        win.document.close();
    }

    function resetData() { if(confirm("Hapus data?")) { dbAbsen = []; localStorage.removeItem('db_final_v13'); renderList(); } }

    window.onload = () => {
        applyTheme(localStorage.getItem('theme_v13') || 'light');
        setDateHeader();
        renderList();
    };
</script>
</body>
</html>
