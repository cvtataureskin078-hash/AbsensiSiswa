<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aplikasi Absesnsi Siswa</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;800&display=swap');
        
        :root { 
            --bg-page: #f1f3f6; --card-bg: #ffffff; --text-main: #000000; 
            --input-bg: #ffffff; --btn-action-bg: #000000; --btn-action-text: #ffffff;
        }
        
        [data-theme="dark"] { 
            --bg-page: #121212; --card-bg: #1e1e1e; --text-main: #ffffff; 
            --input-bg: #2d2d2d; --btn-action-bg: #ffffff; --btn-action-text: #000000;
        }
        
        body { font-family: 'Poppins', sans-serif; background: var(--bg-page); display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; padding: 10px; transition: 0.3s; }
        
        .main-card { 
            background: var(--card-bg); width: 100%; max-width: 820px; 
            display: flex; border-radius: 15px; color: var(--text-main); 
            position: relative; box-shadow: 0 8px 25px rgba(0,0,0,0.1); overflow: hidden;
        }

        .theme-toggle { 
            position: absolute; top: 12px; right: 12px; width: auto;
            padding: 6px 12px; border-radius: 50px; cursor: pointer; border: none; font-size: 9px; font-weight: 800; z-index: 1000;
            background: #000; color: #fff;
        }
        [data-theme="dark"] .theme-toggle { background: #fff; color: #000; }

        .left-panel { flex: 1; padding: 25px; border-right: 1px solid rgba(0,0,0,0.05); }
        .right-panel { flex: 1; padding: 25px; background: rgba(0,0,0,0.01); display: flex; flex-direction: column; }
        
        @media (max-width: 750px) { .main-card { flex-direction: column; } .left-panel, .right-panel { border: none; padding: 20px; } }

        .header-title { margin: 0 0 4px 0; font-weight: 800; font-size: 17px; text-transform: uppercase; }
        .date-display { font-size: 11px; opacity: 0.7; font-weight: 600; margin-bottom: 15px; text-transform: uppercase; }

        #cam-box { width: 100%; height: 180px; background: #000; border-radius: 10px; overflow: hidden; margin-bottom: 15px; position: relative; }
        video { width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); display: none; }
        .cam-placeholder { position: absolute; top:0; left:0; width:100%; height:100%; display: flex; align-items: center; justify-content: center; color: white; font-size: 10px; font-weight: 800; }

        label { font-size: 9px; font-weight: 800; display: block; margin-bottom: 5px; opacity: 0.9; }
        input, select { 
            width: 100%; padding: 10px; border-radius: 8px; border: 1.5px solid rgba(128,128,128,0.2); 
            background: var(--input-bg); color: var(--text-main); box-sizing: border-box; font-family: inherit; 
            margin-bottom: 12px; font-size: 12px; outline: none; 
        }

        .btn-cam { background: #2f3542; color: white; border:none; padding: 12px; border-radius: 10px; cursor:pointer; width: 100%; font-weight: 800; margin-bottom: 15px; transition: 0.3s; font-size: 11px; }

        .btn-action { 
            border: none; border-radius: 10px; cursor: pointer; font-weight: 800; width: 100%; transition: 0.3s; font-size: 11px; text-transform: uppercase;
            background: var(--btn-action-bg) !important; color: var(--btn-action-text) !important; height: 48px; 
            box-shadow: 0 4px 10px rgba(0,0,0,0.1); margin-bottom: 8px;
        }

        #list { flex-grow: 1; overflow-y: auto; max-height: 350px; margin-top: 10px; }
        .item { 
            background: var(--card-bg); padding: 10px; margin-bottom: 8px; border-radius: 12px; 
            display: flex; align-items: center; gap: 10px; border: 1px solid rgba(0,0,0,0.05); 
        }
        .foto-hasil { width: 70px; height: 55px; border-radius: 6px; object-fit: cover; border: 1.5px solid var(--text-main); background: #eee; }
        .info { flex-grow: 1; font-size: 8px; font-weight: 600; text-transform: uppercase; line-height: 1.2; }
        .info b { font-size: 11px; display: block; margin-bottom: 1px; color: var(--text-main); }
        .badge { padding: 4px 8px; border-radius: 6px; color: #fff; font-size: 8px; font-weight: 800; min-width: 50px; text-align: center; }
    </style>
</head>
<body data-theme="light">

    <div class="main-card">
        <button class="theme-toggle" onclick="toggleTheme()" id="tBtn">ðŸŒ™ DARK MODE</button>

        <div class="left-panel">
            <h2 class="header-title">ABSENSI SISWA</h2>
            <div class="date-display" id="tglDisplay"></div>
            
            <div id="cam-box">
                <div id="p-holder" class="cam-placeholder">KAMERA NON-AKTIF</div>
                <video id="video" autoplay muted playsinline></video>
            </div>
            <canvas id="canvas" style="display:none;"></canvas>

            <button id="camBtn" class="btn-cam" onclick="toggleCam()">AKTIFKAN KAMERA</button>
            
            <label>NAMA LENGKAP</label>
            <input type="text" id="nama" placeholder="INPUT NAMA..." style="text-transform: uppercase;">
            
            <div style="display: flex; gap: 12px;">
                <div style="flex: 1;">
                    <label>NOMOR ABSENSI</label>
                    <input type="text" id="no" placeholder="00" oninput="this.value = this.value.replace(/[^0-9]/g, '');">
                </div>
                <div style="flex: 1;">
                    <label>STATUS</label>
                    <select id="stat">
                        <option value="" selected disabled>- PILIH -</option>
                        <option value="HADIR">HADIR</option>
                        <option value="IZIN">IZIN</option>
                        <option value="SAKIT">SAKIT</option>
                        <option value="ALFA">ALFA</option>
                    </select>
                </div>
            </div>
            
            <button class="btn-action" id="btnSimpan" onclick="simpanData()">SIMPAN DATA ABSENSI</button>
        </div>

        <div class="right-panel">
            <h3 class="header-title" style="font-size: 15px;">DAFTAR HADIR</h3>
            <div id="list"></div>
            
            <div style="margin-top: auto;">
                <button class="btn-action" onclick="eksporLaporan()">BUKA LAPORAN (TABLE)</button>
                <button class="btn-action" onclick="resetData()">KOSONGKAN SEMUA DATA</button>
            </div>
        </div>
    </div>

<script>
    let dbAbsen = JSON.parse(localStorage.getItem('db_v60')) || [];
    let video = document.getElementById('video'), canvas = document.getElementById('canvas'), stream = null;
    const COLORS = { 'HADIR': '#10ac84', 'IZIN': '#f1c40f', 'SAKIT': '#e67e22', 'ALFA': '#ee5253' };

    function toggleTheme() {
        let current = document.body.getAttribute('data-theme');
        let next = current === 'light' ? 'dark' : 'light';
        document.body.setAttribute('data-theme', next);
        document.getElementById('tBtn').innerHTML = next === 'dark' ? 'â˜€ï¸ LIGHT MODE' : 'ðŸŒ™ DARK MODE';
        localStorage.setItem('theme_v60', next);
    }

    async function toggleCam() {
        let btn = document.getElementById('camBtn'), holder = document.getElementById('p-holder');
        if (!stream) {
            try {
                stream = await navigator.mediaDevices.getUserMedia({ video: { width: 640, height: 480 } });
                video.srcObject = stream; video.style.display = 'block'; holder.style.display = 'none';
                btn.innerText = "MATIKAN KAMERA"; btn.style.background = "#ff4757";
            } catch (err) { alert("Izinkan akses kamera!"); }
        } else {
            stream.getTracks().forEach(t => t.stop());
            video.srcObject = null; stream = null; video.style.display = 'none'; holder.style.display = 'flex';
            btn.innerText = "AKTIFKAN KAMERA"; btn.style.background = "#2f3542";
        }
    }

    function simpanData() {
        let n = document.getElementById('nama').value, nr = document.getElementById('no').value, s = document.getElementById('stat').value;
        if(!n || !nr || !s) return alert("Lengkapi data!");
        let fotoFinal = "";
        if (stream) {
            canvas.width = 400; canvas.height = 300;
            let ctx = canvas.getContext('2d'); ctx.translate(canvas.width, 0); ctx.scale(-1, 1);
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            fotoFinal = canvas.toDataURL('image/jpeg', 0.8);
        } else {
            canvas.width = 400; canvas.height = 300;
            let ctx = canvas.getContext('2d'); ctx.fillStyle = "#ffffff"; ctx.fillRect(0,0,400,300);
            ctx.fillStyle = "#000000"; ctx.font = "bold 35px Arial"; ctx.textAlign = "center"; ctx.fillText("TANPA FOTO", 200, 160);
            fotoFinal = canvas.toDataURL('image/jpeg');
        }
        const d = new Date();
        let jam = d.getHours().toString().padStart(2, '0') + ":" + d.getMinutes().toString().padStart(2, '0');
        let tgl = d.toLocaleDateString('id-ID', { weekday: 'long', day: '2-digit', month: '2-digit', year: 'numeric' }).toUpperCase();
        dbAbsen.push({ n: n.toUpperCase(), no: nr.padStart(2, '0'), s: s, jam: jam, tgl: tgl, img: fotoFinal });
        localStorage.setItem('db_v60', JSON.stringify(dbAbsen));
        renderList();
        document.getElementById('nama').value = ''; document.getElementById('no').value = ''; document.getElementById('stat').selectedIndex = 0;
    }

    function renderList() {
        let area = document.getElementById('list'); area.innerHTML = '';
        dbAbsen.slice().reverse().forEach(i => {
            area.innerHTML += `<div class="item"><img src="${i.img}" class="foto-hasil"><div class="info"><b>${i.n}</b>NOMOR ABSENSI : ${i.no}<br>TANGGAL : ${i.tgl}<br>PUKUL : ${i.jam}</div><span class="badge" style="background:${COLORS[i.s]}">${i.s}</span></div>`;
        });
    }

    function eksporLaporan() {
        if(dbAbsen.length === 0) return;
        const d = new Date();
        const tglStr = d.getDate().toString().padStart(2,'0') + "-" + (d.getMonth()+1).toString().padStart(2,'0') + "-" + d.getFullYear();
        const fileName = "LAPORAN_ABSENSI_" + tglStr;
        
        let win = window.open('', '_blank');
        win.document.write(`<html><head><title>${fileName}</title>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"><\/script>
        <style>
            @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;800&display=swap');
            body { font-family: 'Poppins', sans-serif; background: #f1f3f6; margin: 0; padding: 40px 20px; display: flex; flex-direction: column; align-items: center; }
            
            /* TOMBOL SIMPAN PDF + SHADOW TIPIS */
            .toolbar { margin-bottom: 30px; }
            .t-btn { 
                background: #27ae60; color: #fff; border: none; padding: 12px 35px; border-radius: 50px; 
                font-weight: 800; cursor: pointer; font-size: 11px; text-transform: uppercase; 
                box-shadow: 0 4px 12px rgba(0,0,0,0.15); transition: 0.3s;
            }
            .t-btn:hover { transform: translateY(-2px); box-shadow: 0 6px 15px rgba(0,0,0,0.2); }
            
            /* KERTAS ROUNDED + SHADOW */
            #pdf-content { 
                background: #fff; width: 750px; padding: 40px; 
                border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.08); 
                box-sizing: border-box; 
            }
            
            h2 { text-align: center; margin: 0 0 30px 0; border-bottom: 3px solid #000; padding-bottom: 15px; font-size: 22px; font-weight: 900; }
            
            .table-container { border: 1.5px solid #000; border-radius: 12px; overflow: hidden; }
            table { width: 100%; border-collapse: collapse; table-layout: fixed; border: none; }
            th { background: #000; color: #fff; padding: 12px 5px; border-bottom: 1.5px solid #000; border-right: 1px solid #333; font-size: 11px; text-transform: uppercase; }
            td { padding: 10px 5px; border-bottom: 1px solid #000; border-right: 1px solid #000; text-align: center; vertical-align: middle; font-size: 11px; color: #000; }
            td:last-child, th:last-child { border-right: none; }
            tr:last-child td { border-bottom: none; }
            
            .img-cell { width: 100px; height: 75px; object-fit: cover; display: block; margin: 0 auto; }
            .st { font-weight: bold; padding: 5px 12px; border-radius: 6px; color: #fff; font-size: 9px; display: inline-block; text-transform: uppercase; }
            
            @media print { 
                body { background: white; padding: 0; }
                .toolbar { display: none; } 
                #pdf-content { width: 100%; box-shadow: none; padding: 0; border-radius: 0; } 
            }
        </style></head>
        <body>
            <div class="toolbar"><button class="t-btn" onclick="downloadPDF()">ðŸ’¾ SIMPAN KE PDF</button></div>
            <div id="pdf-content">
                <h2>LAPORAN DATA ABSENSI SISWA</h2>
                <div class="table-container">
                    <table><thead><tr>
                        <th style="width:110px">FOTO</th>
                        <th style="width:35px">NO</th>
                        <th style="width:190px">NAMA LENGKAP</th>
                        <th style="width:160px">WAKTU & TANGGAL</th>
                        <th style="width:85px">STATUS</th>
                    </tr></thead><tbody>
                        ${dbAbsen.map(i => `<tr>
                            <td style="padding:0;"><img src="${i.img}" class="img-cell"></td>
                            <td><b>${i.no}</b></td>
                            <td style="text-align:left; padding-left:15px; font-weight:bold; font-size:13px; text-transform:uppercase;">${i.n}</td>
                            <td style="font-size:11px; font-weight:bold;">${i.tgl}<br>${i.jam}</td>
                            <td><span class="st" style="background:${COLORS[i.s]}">${i.s}</span></td>
                        </tr>`).join('')}
                    </tbody></table>
                </div>
            </div>
            <script>
                function downloadPDF() {
                    const el = document.getElementById('pdf-content');
                    html2pdf().set({
                        margin: [0.3, 0.3],
                        filename: '${fileName}.pdf',
                        html2canvas: { scale: 2, useCORS: true, width: 750 },
                        jsPDF: { unit: 'in', format: 'a4', orientation: 'portrait' }
                    }).from(el).save();
                }
            <\/script>
        </body></html>`); win.document.close();
    }

    function resetData() { if(confirm("Hapus semua data?")) { dbAbsen = []; localStorage.removeItem('db_v60'); renderList(); } }

    window.onload = () => {
        if(localStorage.getItem('theme_v60') === 'dark') toggleTheme();
        document.getElementById('tglDisplay').innerText = new Date().toLocaleDateString('id-ID', { weekday: 'long', day: '2-digit', month: '2-digit', year: 'numeric' }).toUpperCase();
        renderList();
    };
</script>
</body>
</html>

