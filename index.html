<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Absensi Face Scan Pro</title>
    <script defer src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;800&display=swap');
        :root { --bg: #f0f2f5; --card: #ffffff; --text: #1e272e; --accent: #4834d4; --green: #10ac84; --red: #ff4757; }
        [data-theme="dark"] { --bg: #0a0a0a; --card: #1e1e1e; --text: #ffffff; --accent: #4d3df2; --green: #14bd91; --red: #ff5252; }
        
        body { font-family: 'Poppins', sans-serif; background: var(--bg); display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; padding: 10px; box-sizing: border-box; transition: 0.3s; }
        
        .main-card { 
            background: var(--card); width: 100%; max-width: 1000px; min-height: 600px; 
            display: flex; border-radius: 20px; border: 1px solid rgba(0,0,0,0.1); 
            overflow: hidden; color: var(--text); position: relative; transition: 0.3s;
            box-shadow: 0 10px 30px rgba(0,0,0,0.05);
        }

        .left-panel { flex: 1.2; padding: 30px; display: flex; flex-direction: column; }
        .right-panel { flex: 1; padding: 30px; background: rgba(0,0,0,0.02); border-left: 1px solid rgba(0,0,0,0.05); display: flex; flex-direction: column; }
        
        @media (max-width: 850px) {
            .main-card { flex-direction: column; }
            .left-panel, .right-panel { border-left: none; }
        }

        /* Camera Box */
        #video-container {
            width: 100%; height: 250px; background: #000; border-radius: 15px; 
            overflow: hidden; position: relative; margin-bottom: 15px; border: 3px solid var(--accent);
        }
        video { width: 100%; height: 100%; object-fit: cover; }
        canvas { position: absolute; top: 0; left: 0; }

        input, select { width: 100%; padding: 10px; margin-bottom: 10px; border-radius: 8px; border: 1px solid #ddd; box-sizing: border-box; }
        button { padding: 12px; border: none; border-radius: 8px; cursor: pointer; font-weight: 700; transition: 0.3s; width: 100%; margin-bottom: 5px; }
        
        .btn-cam { background: #2f3542; color: white; }
        .btn-add { background: var(--accent); color: white; }
        .btn-csv { background: var(--green); color: white; margin-top: 10px; }
        .btn-reset { background: var(--red); color: white; font-size: 11px; }

        #list { flex-grow: 1; overflow-y: auto; max-height: 300px; margin-top: 10px; }
        .item { background: var(--card); padding: 10px; margin-bottom: 8px; border-radius: 10px; border-left: 4px solid var(--accent); display: flex; justify-content: space-between; align-items: center; font-size: 13px; }
        .badge { padding: 4px 8px; border-radius: 5px; color: #fff; font-size: 10px; }

        .loading-text { font-size: 12px; color: var(--red); font-weight: 700; text-align: center; margin-bottom: 10px; }
    </style>
</head>
<body data-theme="light">

    <div class="main-card">
        <div class="left-panel">
            <h2>FACE SCANNER</h2>
            <div id="loadingStatus" class="loading-text">Menunggu AI dimuat (Mohon Tunggu)...</div>
            
            <div id="video-container">
                <video id="video" autoplay muted></video>
            </div>

            <button class="btn-cam" onclick="startVideo()">1. AKTIFKAN KAMERA</button>
            
            <label style="font-size: 11px; font-weight: 700;">NAMA SISWA</label>
            <input type="text" id="nama" placeholder="Ketik nama...">
            
            <label style="font-size: 11px; font-weight: 700;">NO ABSEN & STATUS</label>
            <div style="display: flex; gap: 5px;">
                <input type="number" id="no" placeholder="No" style="flex: 0.5;">
                <select id="stat" style="flex: 1.5;">
                    <option value="" selected disabled>-- Pilih Status --</option>
                    <option value="Hadir">Hadir</option>
                    <option value="Izin">Izin</option>
                    <option value="Sakit">Sakit</option>
                    <option value="Alfa">Alfa</option>
                </select>
            </div>
            
            <button class="btn-add" id="btnAdd" onclick="tambah()" disabled>2. SCAN & TAMBAH KE LIST</button>
        </div>

        <div class="right-panel">
            <h3 style="margin:0;">Daftar Hadir</h3>
            <div id="list"></div>
            
            <button class="btn-csv" onclick="ekspor()">üíæ SIMPAN CSV</button>
            <button class="btn-reset" onclick="hapusSemua()">üóëÔ∏è RESET DATA</button>
        </div>
    </div>

<script>
    let dataAbsen = JSON.parse(localStorage.getItem('face_absen_data')) || [];
    const video = document.getElementById('video');

    // 1. Load Model AI
    Promise.all([
        faceapi.nets.tinyFaceDetector.loadFromUri('https://raw.githubusercontent.com/ml5js/ml5-data-and-models/main/models/faceapi/tiny_face_detector_model-weights_manifest.json'),
    ]).then(() => {
        document.getElementById('loadingStatus').innerText = "‚úÖ AI SIAP! Silakan buka kamera.";
        document.getElementById('loadingStatus').style.color = "green";
    });

    function startVideo() {
        navigator.mediaDevices.getUserMedia({ video: {} })
            .then(stream => {
                video.srcObject = stream;
                document.getElementById('btnAdd').disabled = false;
                detect();
            })
            .catch(err => alert("Gagal akses kamera: " + err));
    }

    async function detect() {
        const canvas = faceapi.createCanvasFromMedia(video);
        document.getElementById('video-container').append(canvas);
        const displaySize = { width: video.clientWidth, height: video.clientHeight };
        faceapi.matchDimensions(canvas, displaySize);

        setInterval(async () => {
            const detections = await faceapi.detectAllFaces(video, new faceapi.TinyFaceDetectorOptions());
            const resizedDetections = faceapi.resizeResults(detections, displaySize);
            canvas.getContext('2d').clearRect(0, 0, canvas.width, canvas.height);
            faceapi.draw.drawDetections(canvas, resizedDetections);
        }, 100);
    }

    function tambah() {
        const n = document.getElementById('nama').value;
        const nr = document.getElementById('no').value;
        const s = document.getElementById('stat').value;

        if(!n || !nr || !s) return alert("Isi data dulu!");

        const waktu = new Date().toLocaleTimeString('id-ID', {hour:'2-digit', minute:'2-digit'});
        dataAbsen.push({ n, no: String(nr).padStart(2,'0'), s, jam: waktu });
        
        localStorage.setItem('face_absen_data', JSON.stringify(dataAbsen));
        render();
        
        // Clear input
        document.getElementById('nama').value = '';
        document.getElementById('no').value = '';
        document.getElementById('stat').selectedIndex = 0;
    }

    function render() {
        const list = document.getElementById('list');
        list.innerHTML = '';
        const colors = {'Hadir': '#10ac84', 'Izin': '#f1c40f', 'Sakit': '#e67e22', 'Alfa': '#ee5253'};
        
        [...dataAbsen].reverse().forEach(x => {
            list.innerHTML += `<div class="item">
                <div><b>${x.n}</b> (No: ${x.no})<br><small>${x.jam}</small></div>
                <span class="badge" style="background:${colors[x.s]}">${x.s}</span>
            </div>`;
        });
    }

    function ekspor() {
        if(dataAbsen.length === 0) return alert("Data kosong!");
        let csv = "sep=,\nNama,No,Jam,Status\n";
        dataAbsen.forEach(x => csv += `"${x.n}","${x.no}","${x.jam}","${x.s}"\n`);
        const blob = new Blob(["\uFEFF" + csv], { type: 'text/csv' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = 'Absen_FaceScan.csv';
        a.click();
    }

    function hapusSemua() {
        dataAbsen = [];
        localStorage.removeItem('face_absen_data');
        render();
    }

    window.onload = render;
</script>
</body>
</html>
