<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Absensi Siswa</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;800&display=swap');
        :root { --bg: #f0f2f5; --card: #ffffff; --text: #1e272e; --accent: #4834d4; --green: #10ac84; --red: #ff4757; }
        [data-theme="dark"] { --bg: #0a0a0a; --card: #1e1e1e; --text: #ffffff; --accent: #4d3df2; --green: #14bd91; --red: #ff5252; }
        
        body { font-family: 'Poppins', sans-serif; background: var(--bg); display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; padding: 10px; box-sizing: border-box; transition: 0.3s; }
        
        .main-card { 
            background: var(--card); width: 100%; max-width: 1000px; 
            display: flex; border-radius: 20px; color: var(--text); 
            position: relative; box-shadow: 0 10px 30px rgba(0,0,0,0.1); transition: 0.3s;
        }

        .theme-toggle { 
            position: absolute !important; top: 20px !important; right: 20px !important; width: auto !important;
            padding: 8px 18px !important; border-radius: 50px; display: flex; align-items: center; gap: 8px;
            cursor: pointer; border: none; font-size: 11px; font-weight: 800; z-index: 1000;
            white-space: nowrap; transform: scale(1.05) !important; transform-origin: right top;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15); transition: 0.2s;
        }

        [data-theme="light"] .theme-toggle { background: #1e272e; color: #ffffff; }
        [data-theme="dark"] .theme-toggle { background: #ffffff; color: #1e272e; }

        .left-panel { flex: 1.2; padding: 35px; }
        .right-panel { flex: 1; padding: 30px; background: rgba(0,0,0,0.02); border-left: 1px solid rgba(0,0,0,0.05); border-radius: 0 20px 20px 0; display: flex; flex-direction: column; }
        
        @media (max-width: 850px) { 
            .main-card { flex-direction: column; margin-top: 20px; } 
            .right-panel { border-left: none; border-top: 1px solid rgba(0,0,0,0.1); border-radius: 0 0 20px 20px; } 
            .theme-toggle { top: 15px !important; right: 15px !important; transform: scale(1.03) !important; }
            .left-panel { padding: 45px 20px 25px 20px; }
        }

        .date-header { font-size: 13px; opacity: 0.7; font-weight: 600; margin-bottom: 15px; }
        #cam-box { width: 100%; height: 230px; background: #000; border-radius: 15px; overflow: hidden; margin-bottom: 15px; }
        video { width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); }
        canvas { display: none; }

        label { font-size: 11px; font-weight: 700; display: block; margin-bottom: 5px; opacity: 0.7; }
        input, select { width: 100%; padding: 13px; border-radius: 10px; border: 1px solid rgba(0,0,0,0.1); background: var(--card); color: var(--text); box-sizing: border-box; font-family: inherit; margin-bottom: 15px; outline: none; }
        
        button { border: none; border-radius: 12px; cursor: pointer; font-weight: 800; padding: 14px; width: 100%; transition: 0.3s; }
        .btn-cam { background: #2f3542; color: white; margin-bottom: 10px; font-size: 12px; }
        .btn-cam.active { background: var(--red); }
        .btn-add { background: var(--accent); color: white; font-size: 16px; height: 55px; box-shadow: 0 4px 12px rgba(72, 52, 212, 0.2); }
        .btn-csv { background: var(--green); color: white; margin-top: 15px; }
        .btn-reset { background: var(--red); color: white; margin-top: 10px; font-size: 11px; padding: 10px; }

        #list { flex-grow: 1; overflow-y: auto; max-height: 400px; margin-top: 10px; }
        .item { background: var(--card); padding: 15px; margin-bottom: 12px; border-radius: 15px; display: flex; align-items: center; gap: 15px; border: 1px solid rgba(0,0,0,0.05); }
        .foto-hasil { width: 70px; height: 70px; border-radius: 12px; object-fit: cover; border: 1px solid #000; }
        .info { flex-grow: 1; font-size: 12px; line-height: 1.6; }
        .badge { padding: 6px 12px; border-radius: 8px; color: #fff; font-size: 10px; font-weight: 800; }
    </style>
</head>
<body data-theme="light">

    <div class="main-card">
        <button class="theme-toggle" onclick="gantiTema()" id="tBtn">ðŸŒ™ DARK MODE</button>

        <div class="left-panel">
            <h2 style="margin:0; font-weight: 800;">ABSENSI SISWA</h2>
            <div class="date-header" id="tglDisplay"></div>
            
            <div id="cam-box">
                <video id="video" autoplay muted playsinline></video>
            </div>
            <canvas id="canvas"></canvas>

            <button id="camBtn" class="btn-cam" onclick="nyalainKamera()">NYALAKAN KAMERA</button>
            
            <label>NAMA SISWA</label>
            <input type="text" id="nama" placeholder="MASUKKAN NAMA LENGKAP..." style="text-transform: uppercase;">
            
            <div style="display: flex; gap: 10px;">
                <div style="flex: 1.2;">
                    <label>NOMOR ABSENSI</label>
                    <input type="text" id="no" placeholder="MASUKAN NO..." oninput="this.value = this.value.replace(/[^0-9]/g, '');">
                </div>
                <div style="flex: 1;">
                    <label>STATUS</label>
                    <select id="stat">
                        <option value="" selected disabled>- PILIH STATUS -</option>
                        <option value="Hadir">HADIR</option>
                        <option value="Izin">IZIN</option>
                        <option value="Sakit">SAKIT</option>
                        <option value="Alfa">ALFA</option>
                    </select>
                </div>
            </div>
            
            <button class="btn-add" onclick="tambah()">SIMPAN DATA & FOTO</button>
        </div>

        <div class="right-panel">
            <h3 style="margin:0; font-weight: 800;">DAFTAR HADIR</h3>
            <div id="list"></div>
            <button class="btn-csv" onclick="ekspor()">EKSPOR DAFTAR HADIR</button>
            <button class="btn-reset" onclick="hapusSemua()">KOSONGKAN DAFTAR HADIR</button>
        </div>
    </div>

<script>
    var dataLokal = JSON.parse(localStorage.getItem('catatan_absen_siswa')) || [];
    var video = document.getElementById('video');
    var canvas = document.getElementById('canvas');
    var aliranKamera = null;

    function pasangTema(pilihan) {
        document.body.setAttribute('data-theme', pilihan);
        document.getElementById('tBtn').innerHTML = pilihan === 'dark' ? 'â˜€ï¸ LIGHT MODE' : 'ðŸŒ™ DARK MODE';
        localStorage.setItem('setelan_tema', pilihan);
    }

    function gantiTema() {
        var skrg = document.body.getAttribute('data-theme');
        var baru = (skrg === 'light') ? 'dark' : 'light';
        pasangTema(baru);
    }

    function formatTanggal() {
        var d = new Date();
        return String(d.getDate()).padStart(2, '0') + "/" + String(d.getMonth() + 1).padStart(2, '0') + "/" + d.getFullYear();
    }

    function setTgl() {
        var d = new Date();
        var hari = ["MINGGU", "SENIN", "SELASA", "RABU", "KAMIS", "JUMAT", "SABTU"];
        document.getElementById('tglDisplay').innerText = hari[d.getDay()] + ", " + formatTanggal();
    }

    function nyalainKamera() {
        var btn = document.getElementById('camBtn');
        if (!aliranKamera) {
            navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" } })
            .then(function(s) {
                aliranKamera = s; video.srcObject = s;
                btn.innerText = "MATIKAN KAMERA"; btn.classList.add('active');
            }).catch(function(e) { });
        } else {
            aliranKamera.getTracks().forEach(t => t.stop());
            video.srcObject = null; aliranKamera = null;
            btn.innerText = "NYALAKAN KAMERA"; btn.classList.remove('active');
        }
    }

    function tambah() {
        var n = document.getElementById('nama').value;
        var nr = document.getElementById('no').value;
        var s = document.getElementById('stat').value;
        if(!n || !nr || !s) return;

        var noAbsen = nr.toString().padStart(2, '0');
        var gambar = "https://via.placeholder.com/150?text=No+Photo";

        if (aliranKamera) {
            canvas.width = 150; canvas.height = 110;
            var ctx = canvas.getContext('2d');
            ctx.translate(canvas.width, 0); ctx.scale(-1, 1);
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            gambar = canvas.toDataURL('image/jpeg', 0.7);
        }

        var d = new Date();
        var waktu = d.getHours().toString().padStart(2, '0') + ":" + d.getMinutes().toString().padStart(2, '0');
        dataLokal.push({ n: n.toUpperCase(), no: noAbsen, s: s.toUpperCase(), jam: waktu, tgl: formatTanggal(), img: gambar });
        localStorage.setItem('catatan_absen_siswa', JSON.stringify(dataLokal));
        render();
        document.getElementById('nama').value = '';
        document.getElementById('no').value = '';
        document.getElementById('stat').selectedIndex = 0;
    }

    function render() {
        var tempatList = document.getElementById('list');
        tempatList.innerHTML = '';
        var warnaLabel = {'HADIR': '#10ac84', 'IZIN': '#f1c40f', 'SAKIT': '#e67e22', 'ALFA': '#ee5253'};
        dataLokal.slice().reverse().forEach(item => {
            tempatList.innerHTML += `
                <div class="item">
                    <img src="${item.img}" class="foto-hasil">
                    <div class="info">
                        <b style="font-size: 14px; text-transform: uppercase;">${item.n}</b><br>
                        NOMOR ABSENSI: ${item.no}<br>
                        TANGGAL: ${item.tgl}<br>
                        PUKUL: ${item.jam}
                    </div>
                    <span class="badge" style="background:${warnaLabel[item.s]}">${item.s}</span>
                </div>`;
        });
    }

    function ekspor() {
        if(dataLokal.length === 0) return;
        const warnaBadge = { 'HADIR': '#10ac84', 'IZIN': '#f1c40f', 'SAKIT': '#e67e22', 'ALFA': '#ee5253' };
        
        let html = `
        <html>
        <head>
            <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;700;800&display=swap" rel="stylesheet">
            <style>
                * { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
                body { font-family: 'Poppins', sans-serif; padding: 20px; color: #1e272e; text-transform: uppercase; }
                .header { text-align: center; margin-bottom: 20px; border-bottom: 3px solid #4834d4; padding-bottom: 5px; }
                h2 { color: #4834d4; margin: 0; font-weight: 800; font-size: 24px; }
                .header p { margin: 5px 0 10px 0; font-size: 13px; font-weight: 600; opacity: 0.8; }
                table { width: 100%; border-collapse: collapse; margin-top: 10px; table-layout: fixed; }
                th { background-color: #4834d4 !important; color: white !important; padding: 15px 5px; text-align: center; font-size: 14px; font-weight: 800; border: 1px solid #4834d4; }
                td { padding: 12px 5px; border: 1px solid #ddd; font-size: 14px; font-weight: 600; vertical-align: middle; text-align: center; word-wrap: break-word; }
                tr:nth-child(even) { background-color: #f8f9fa !important; }
                .foto { width: 100px; height: 100px; border-radius: 10px; object-fit: cover; border: 2px solid #1e272e; display: inline-block; }
                .status-chip { padding: 6px 12px; border-radius: 4px; color: white !important; font-weight: 800; font-size: 12px; display: inline-block; }
                @media print { body { padding: 0; } .header { border-bottom: 2px solid #000; } }
            </style>
        </head>
        <body onload="window.print()">
            <div class="header">
                <h2>LAPORAN ABSENSI SISWA</h2>
                <p>DICETAK PADA: ${new Date().toLocaleString('id-ID')}</p>
            </div>
            <table>
                <thead>
                    <tr>
                        <th style="width: 120px;">FOTO</th>
                        <th style="width: 130px;">NOMOR ABSENSI</th>
                        <th>NAMA SISWA</th>
                        <th style="width: 120px;">TANGGAL</th>
                        <th style="width: 90px;">WAKTU</th>
                        <th style="width: 110px;">STATUS</th>
                    </tr>
                </thead>
                <tbody>`;

        dataLokal.forEach(item => {
            const st = item.s.toUpperCase();
            html += `
                <tr>
                    <td><img src="${item.img}" class="foto"></td>
                    <td style="font-size: 18px;">${item.no}</td>
                    <td style="font-size: 15px;">${item.n}</td>
                    <td>${item.tgl}</td>
                    <td>${item.jam}</td>
                    <td><span class="status-chip" style="background-color: ${warnaBadge[st]} !important;">${st}</span></td>
                </tr>`;
        });

        html += `</tbody></table></body></html>`;
        var file = new Blob([html], { type: 'text/html' });
        var a = document.createElement("a");
        a.href = URL.createObjectURL(file);
        a.download = "LAPORAN_ABSENSI_" + formatTanggal().replace(/\//g, '-') + ".html";
        a.click();
    }

    function hapusSemua() { 
        if(confirm("HAPUS SEMUA DAFTAR HADIR?")) {
            dataLokal = []; localStorage.removeItem('catatan_absen_siswa'); render(); 
        }
    }
    
    window.onload = function() { 
        var temaDulu = localStorage.getItem('setelan_tema') || 'light';
        pasangTema(temaDulu); setTgl(); render(); 
    };
</script>
</body>
</html>
